import streamlit as st
import pandas as pd
from utils.io_helpers import path_in_data, load_csv_safe
from utils.visuals import (
    heatmap,
    top_vulnerabilities,
    plot_top_vulnerabilities_for_country,
    plot_top_countries_by_indicator,
    VULN_INDICATORS
)

st.title("📊 Vulnerability Analysis")

# =============================
# Load dataset
# =============================
df = load_csv_safe(path_in_data("final_with_indexes.csv"))
if df is None:
    st.error("❌ final_with_indexes.csv not found in /data/")
    st.stop()

# =============================
# Country selector
# =============================
iso3 = st.selectbox("🌍 Select Country", sorted(df["ISO3"].unique()))

# =============================
# Heatmap
# =============================
st.subheader(f"📈 Vulnerability Heatmap – {iso3}")
fig = heatmap(df, iso3, fw=14, fh=6)
st.pyplot(fig, use_container_width=True)

# =============================
# Top vulnerabilities (cards + chart)
# =============================
st.subheader(f"⚠️ Top 3 Vulnerabilities – {iso3}")
vulns = top_vulnerabilities(df, iso3, n=3)

if vulns:
    # metric cards
    c1, c2, c3 = st.columns(3)
    for i, (name, score) in enumerate(vulns):
        with [c1, c2, c3][i]:
            st.metric(label=name, value=f"{score:.2f}")

    # bar chart
    fig_bar = plot_top_vulnerabilities_for_country(df, iso3, top_n=3)
    if fig_bar:
        st.pyplot(fig_bar, use_container_width=False)
else:
    st.info("ℹ️ Not enough data to compute vulnerabilities.")

# =============================
# Optional: Compare across countries
# =============================
st.subheader("🌍 Compare Countries by One Indicator")
indicator = st.selectbox("Select indicator to compare", VULN_INDICATORS)
if indicator in df.columns:
    fig_comp = plot_top_countries_by_indicator(df, indicator, top_n=10)
    st.plotly_chart(fig_comp, use_container_width=True)
else:
    st.warning(f"Indicator `{indicator}` not found in dataset.")

# =============================
# Show all indicators
# =============================
with st.expander("🔍 Vulnerability Indicators Used"):
    st.write(VULN_INDICATORS)
